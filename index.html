<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suite de Análisis de Dominios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6;
            border-radius: 50%; width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .check-label { transition: all 0.2s ease-in-out; }
        .check-label:hover { background-color: #f9fafb; }
        .result-item .label { min-width: 140px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 my-8">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Internet Society Uruguay (Mediciones ISOC-LAC)</h1>
            <p class="text-gray-500 mt-2">Proyecto colaborativo de capítulos de Internet Society para mediciones abiertas de la región LAC.</p>
            <button id="aboutBtn" class="text-blue-600 underline text-sm mt-2">Acerca de</button>
            <div id="aboutText" class="hidden mt-4 text-sm text-gray-700">
                El Capítulo Uruguay de Internet Society, junto a otros capítulos de la región,
                desarrolló esta herramienta abierta para medir la adopción de tecnologías y buenas prácticas
                en América Latina y el Caribe. Esta plataforma se integrará con ISOC Pulse para
                recopilar y compartir información regional.
            </div>
        </div>

        <div class="mb-6">
            <label for="countrySelect" class="block text-sm font-medium text-gray-700 mb-2">Selecciona un país</label>
            <select id="countrySelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                <option value="" selected disabled>-- País --</option>
            </select>
        </div>

        <div class="mb-6">
            <label for="domains" class="block text-sm font-medium text-gray-700 mb-2">Dominios (separados por coma)</label>
            <textarea id="domains" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="google.com, nic.uy, lacnic.net"></textarea>
        </div>

        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-3">Verificaciones a realizar</label>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="dnssec" class="h-4 w-4 rounded" checked><span class="ml-2 text-sm">DNSSEC</span></label>
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="ipv4" class="h-4 w-4 rounded" checked><span class="ml-2 text-sm">IPv4</span></label>
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="ipv6" class="h-4 w-4 rounded" checked><span class="ml-2 text-sm">IPv6</span></label>
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="asn" class="h-4 w-4 rounded" checked><span class="ml-2 text-sm">ASN</span></label>
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="rpki" class="h-4 w-4 rounded"><span class="ml-2 text-sm">RPKI</span></label>
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="whois" class="h-4 w-4 rounded"><span class="ml-2 text-sm">WHOIS</span></label>
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="dmarc" class="h-4 w-4 rounded" checked><span class="ml-2 text-sm">DMARC</span></label>
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="spf" class="h-4 w-4 rounded" checked><span class="ml-2 text-sm">SPF</span></label>
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="dkim" class="h-4 w-4 rounded"><span class="ml-2 text-sm">DKIM</span></label>
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="mx" class="h-4 w-4 rounded"><span class="ml-2 text-sm">MX</span></label>
                <label class="check-label flex items-center p-2 border rounded-lg cursor-pointer"><input type="checkbox" data-check="smtputf8" class="h-4 w-4 rounded"><span class="ml-2 text-sm">SMTPUTF8</span></label>
                </div>
        </div>

        <div class="flex flex-col items-center justify-center">
            <button id="checkButton" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 9a2 2 0 114 0 2 2 0 01-4 0z" /><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a4 4 0 00-3.446 6.032l-2.261 2.26a1 1 0 101.414 1.414l2.26-2.26a4 4 0 10-1.15-7.446z" clip-rule="evenodd" /></svg>
                <span>Analizar Dominios</span>
            </button>
            <div class="flex space-x-4 mt-4">
                <button id="historyButton" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Ver Historial</button>
                <button id="clearHistoryButton" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Limpiar Historial</button>
            </div>
        </div>

        <div id="history" class="mt-6 hidden"></div>

        <div id="results-container" class="mt-8">
            <div id="loader" class="hidden items-center justify-center py-4">
                <div class="loader"></div><p class="ml-3 text-gray-600">Analizando...</p>
            </div>
            <div id="results" class="space-y-6"></div>
        </div>
        <div id="map" class="w-full h-64 mt-8 hidden"></div>
    </div>

<script>
    const checkButton = document.getElementById('checkButton');
    const domainsInput = document.getElementById('domains');
    const resultsContainer = document.getElementById('results');
    const loader = document.getElementById('loader');
    const checkboxes = document.querySelectorAll('input[type="checkbox"][data-check]');
    const historyButton = document.getElementById('historyButton');
    const clearHistoryButton = document.getElementById('clearHistoryButton');
    const historyDiv = document.getElementById('history');
    const aboutBtn = document.getElementById('aboutBtn');
    const aboutText = document.getElementById('aboutText');
    const mapDiv = document.getElementById('map');
    let map; let mapMarkers = [];
        const API_BASE = 'http://localhost:3000';

    const countryTlds = {
        'Uruguay': ['uy','com.uy','edu.uy','gub.uy','org.uy','net.uy','mil.uy','destinosnaturales.gub.uy','agesic.gub.uy'],
        'Argentina': ['ar','com.ar','gob.ar','edu.ar','org.ar','net.ar'],
        'Brasil': ['br','com.br','gov.br','edu.br','org.br','net.br'],
        'Ecuador': ['ec','com.ec','gob.ec','edu.ec','org.ec','net.ec'],
        'Bolivia': ['bo','com.bo','gob.bo','edu.bo','org.bo','net.bo'],
        'Chile': ['cl','com.cl','gob.cl','edu.cl','org.cl','net.cl'],
        'Paraguay': ['py','com.py','gov.py','edu.py','org.py','net.py'],
        'Perú': ['pe','com.pe','gob.pe','edu.pe','org.pe','net.pe'],
        'Colombia': ['co','com.co','gov.co','edu.co','org.co','net.co'],
        'México': ['mx','com.mx','gob.mx','edu.mx','org.mx','net.mx']
    };

    for (const country of Object.keys(countryTlds)) {
        const opt = document.createElement('option');
        opt.value = country;
        opt.textContent = country;
        countrySelect.appendChild(opt);
    }

    countrySelect.addEventListener('change', () => {
        const domains = countryTlds[countrySelect.value] || [];
        domainsInput.value = domains.join(', ');
    });

    aboutBtn.addEventListener('click', () => {
        aboutText.classList.toggle('hidden');
    });

    function initMap() {
        map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
    }
    initMap();

    function clearMap() {
        mapMarkers.forEach(m => map.removeLayer(m));
        mapMarkers = [];
    }

    function updateMap(domain, geos) {
        if (!geos || !geos.length) return;
        mapDiv.classList.remove('hidden');
        geos.forEach(g => {
            const marker = L.marker([g.lat, g.lon]).addTo(map).bindPopup(`${domain} (${g.ip}) - ${g.country || ''}`);
            mapMarkers.push(marker);
        });
        map.setView([geos[0].lat, geos[0].lon], 2);
    }

    const checkConfig = {
        dnssec: { label: 'DNSSEC' },
        ipv4: { label: 'IPv4' },
        ipv6: { label: 'IPv6' },
        asn: { label: 'ASN' },
        rpki: { label: 'RPKI' },
        whois: { label: 'WHOIS' },
        dmarc: { label: 'DMARC' },
        spf: { label: 'SPF' },
        dkim: { label: 'DKIM' },
        mx: { label: 'MX' },
        smtputf8: { label: 'SMTPUTF8' }
    };

    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('domainHistory') || '[]');
        if (!history.length) {
            historyDiv.innerHTML = '<div class="text-center text-gray-500">Sin historial</div>';
            return;
        }
        let html = '';
        history.forEach(entry => {
            html += `<div class="mb-4"><h4 class="font-semibold mb-2">${entry.date}</h4>`;
            html += '<div class="overflow-auto"><table class="min-w-full text-sm border"><thead><tr><th class="border px-2 py-1">Dominio</th>';
            entry.checks.forEach(c => { html += `<th class="border px-2 py-1">${checkConfig[c]?.label || c}</th>`; });
            html += '</tr></thead><tbody>';
            entry.domains.forEach(d => {
                html += `<tr><td class="border px-2 py-1">${d.domain}</td>`;
                entry.checks.forEach(c => {
                    const val = d.results[c]?.status || '-';
                    html += `<td class="border px-2 py-1 text-center">${val}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div></div>';
        });
        historyDiv.innerHTML = html;
    }

    function saveHistory(entry) {
        const history = JSON.parse(localStorage.getItem('domainHistory') || '[]');
        history.push(entry);
        localStorage.setItem('domainHistory', JSON.stringify(history));
    }

    async function fetchWithTimeout(resource, options = {}, timeout = 20000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
            const response = await fetch(resource, { ...options, signal: controller.signal });
            clearTimeout(id);
            if (!response.ok) throw new Error(`API falló (${response.status})`);
            return response.json();
        } catch (error) {
            clearTimeout(id);
            throw new Error(error.name === 'AbortError' ? 'Timeout' : error.message);
        }
    }

    function getStatusHtml(status, details = '') {
        let icon, color, text;
        switch (status) {
            case 'ok':
                icon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                color = 'text-green-600'; text = details; break;
            case 'fail':
                icon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                color = 'text-red-600'; text = details; break;
            default:
                icon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                color = 'text-yellow-600'; text = details; break;
        }
        return `<div class="flex items-center ${color}"><span class="mr-2 flex-shrink-0">${icon}</span><span class="font-semibold text-sm">${text}</span></div>`;
    }

    function renderResultCard(domain, results) {
        const card = document.createElement('div');
        card.className = 'p-4 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';
        const groups = {
            "Configuración DNS y Red": ['dnssec', 'ipv4', 'ipv6', 'asn', 'rpki'],
            "Registros de Correo y EAI": ['dmarc', 'spf', 'dkim', 'smtputf8', 'mx'],
            "Información del Dominio": ['whois']
        };
        let cardHtml = `<h3 class="font-bold text-xl text-gray-800 mb-4 pb-2 border-b">${domain}</h3>`;
        for (const [groupTitle, checkKeys] of Object.entries(groups)) {
            const groupResults = checkKeys.map(key => results[key]).filter(Boolean);
            if (groupResults.length > 0) {
                cardHtml += `<h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">${groupTitle}</h4>`;
                groupResults.forEach(({ label, status, details }) => {
                    cardHtml += `
                        <div class="result-item flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                            <span class="label text-sm font-medium text-gray-600">${label}</span>
                            ${getStatusHtml(status, details)}
                        </div>`;
                });
            }
        }
        card.innerHTML = cardHtml;
        resultsContainer.appendChild(card);
    }

    async function getCheckResult(checkType, domain) {
        const { label } = checkConfig[checkType];
        try {
            switch (checkType) {
                case 'dnssec': {
                    const data = await fetchWithTimeout(`${API_BASE}/dnssec/${domain}`);
                    const ok = data.valid;
                    const details = ok
                        ? (data.algorithms?.length ? `Algoritmos: ${data.algorithms.join(', ')}` : 'DNSSEC configurado')
                        : '¡No tiene DNSSEC!';
                    return { label, status: ok ? 'ok' : 'fail', details };
                }
                case 'ipv4': {
                    const data = await fetchWithTimeout(`https://dns.google/resolve?name=${domain}&type=A`);
                    const ips = data.Answer?.filter(r => r.type === 1).map(r => r.data) || [];
                    const geos = [];
                    for (const ip of ips) {
                        try {
                            const info = await fetchWithTimeout(`https://ipapi.co/${ip}/json/`);
                            geos.push({ ip, country: info.country_name, lat: info.latitude, lon: info.longitude, asn: info.asn });
                        } catch (e) {}
                    }
                    const details = ips.length ? ips.join(', ') : 'No tiene IPv4';
                    return { label, status: ips.length ? 'ok' : 'fail', details, geos };
                }
                case 'ipv6': {
                    const data = await fetchWithTimeout(`https://dns.google/resolve?name=${domain}&type=AAAA`);
                    const ips = data.Answer?.filter(r => r.type === 28).map(r => r.data) || [];
                    return { label, status: ips.length ? 'ok' : 'fail', details: ips.length ? ips.join(', ') : 'No tiene IPv6' };
                }
                case 'asn': {
                    const data = await fetchWithTimeout(`https://dns.google/resolve?name=${domain}&type=A`);
                    const ip = data.Answer?.find(r => r.type === 1)?.data;
                    if (!ip) return { label, status: 'fail', details: 'Sin IPv4' };
                    const info = await fetchWithTimeout(`https://ipapi.co/${ip}/json/`);
                    return { label, status: info.asn ? 'ok' : 'fail', details: info.asn || 'Sin datos' };
                }
                case 'dmarc': {
                    const data = await fetchWithTimeout(`https://dns.google/resolve?name=_dmarc.${domain}&type=TXT`);
                    const found = data.Answer?.some(r => r.data.includes("v=DMARC1"));
                    return { label, status: found ? 'ok' : 'fail', details: found ? 'Política encontrada' : 'No permite DMARC' };
                }
                case 'spf': {
                    const data = await fetchWithTimeout(`https://dns.google/resolve?name=${domain}&type=TXT`);
                    const found = data.Answer?.some(r => r.data.includes("v=spf1"));
                    return { label, status: found ? 'ok' : 'fail', details: found ? 'Registro encontrado' : 'No permite SPF' };
                }
                case 'dkim': {
                    const data = await fetchWithTimeout(`${API_BASE}/dkim/${domain}?selector=default`);
                    return { label, status: data.found ? 'ok' : 'fail', details: data.found ? 'Registro encontrado' : 'No permite DKIM' };
                }
                case 'mx': {
                    const data = await fetchWithTimeout(`${API_BASE}/mx/${domain}`);
                    const details = data.records?.map(r => `${r.exchange} (p${r.priority})`).join(', ') || 'No permite MX';
                    return { label, status: data.records?.length ? 'ok' : 'fail', details };
                }
                case 'smtputf8': {
                    const data = await fetchWithTimeout(`${API_BASE}/smtputf8/${domain}`);
                    const details = data.results?.map(r => {
                        switch (r.status) {
                            case 'supports': return `${r.server}: sí`;
                            case 'no': return `${r.server}: no`;
                            case 'timeout': return `${r.server}: timeout`;
                            case 'connection-error': return `${r.server}: sin conexión`;
                            default: return `${r.server}: sin datos`;
                        }
                    }).join('; ') || 'No permite SMTPUTF8';
                    const ok = data.results?.length && data.results.every(r => r.status === 'supports');
                    return { label, status: ok ? 'ok' : 'fail', details };
                }
                case 'rpki': {
                    const data = await fetchWithTimeout(`${API_BASE}/rpki/${domain}`);
                    const details = data.results?.map(r => {
                        const estado = r.ripeStat?.status || '-';
                        const asn = r.ripeStat?.asn ? ` AS${r.ripeStat.asn}` : '';
                        return `${r.ip}: Cloudflare ${r.cloudflare ? 'sí' : 'no'}, RIPE ${r.ripe ? 'sí' : 'no'}, Estado ${estado}${asn}`;
                    }).join('; ') || 'No tiene RPKI';
                    return { label, status: data.valid ? 'ok' : 'fail', details };
                }
                case 'whois': {
                    const data = await fetchWithTimeout(`${API_BASE}/whois/${domain}`);
                    const details = data.country ? `${data.name || 'Desconocido'} (${data.country})` : (data.name || 'Desconocido');
                    return { label, status: data.name ? 'ok' : 'fail', details };
                }
            }
        } catch (error) {
            return { label, status: 'error', details: error.message };
        }
    }

    async function analyzeDomain(domain, selectedChecks) {
        const promises = selectedChecks.map(checkType => getCheckResult(checkType, domain));
        const settledResults = await Promise.allSettled(promises);
        const finalResults = {};
        settledResults.forEach((res, index) => {
            const checkType = selectedChecks[index];
            if (res.status === 'fulfilled' && res.value) {
                finalResults[checkType] = res.value;
            } else if (res.status === 'rejected') {
                finalResults[checkType] = { label: checkConfig[checkType].label, status: 'error', details: res.reason.message };
            }
        });
        renderResultCard(domain, finalResults);
        return { domain, results: finalResults };
    }

    async function handleAnalysis() {
        resultsContainer.innerHTML = '';
        loader.style.display = 'flex';
        checkButton.disabled = true;
        clearMap();

        const domains = domainsInput.value.trim().split(',').map(d => d.trim()).filter(Boolean);
        const selectedChecks = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.dataset.check);

        if (!domains.length || !selectedChecks.length) {
            loader.style.display = 'none';
            checkButton.disabled = false;
            resultsContainer.innerHTML = `<div class="text-center text-gray-500 p-4">${!domains.length ? 'Introduce al menos un dominio.' : 'Selecciona al menos una verificación.'}</div>`;
            return;
        }

        const historyEntry = { date: new Date().toLocaleString(), checks: selectedChecks, domains: [] };
        for (const domain of domains) {
            const res = await analyzeDomain(domain, selectedChecks);
            historyEntry.domains.push(res);
            if (res.results.ipv4?.geos) updateMap(domain, res.results.ipv4.geos);
        }
        saveHistory(historyEntry);

        loader.style.display = 'none';
        checkButton.disabled = false;
    }

    historyButton.addEventListener('click', () => {
        const hidden = historyDiv.classList.toggle('hidden');
        if (!hidden) loadHistory();
    });

    clearHistoryButton.addEventListener('click', () => {
        localStorage.removeItem('domainHistory');
        loadHistory();
    });

    checkButton.addEventListener('click', handleAnalysis);
</script>
</body>
</html>
